# =============================================================================
# Docker Compose - Container Vulnerability Scanner
# =============================================================================
# Services:
#   - db:       PostgreSQL database
#   - api:      FastAPI backend server
#   - worker:   Trivy scanner background worker
#   - frontend: React + Nginx frontend
#
# Usage:
#   docker-compose up -d              # Start all services
#   docker-compose up -d --build      # Rebuild and start
#   docker-compose logs -f api        # Follow API logs
#   docker-compose down -v            # Stop and remove volumes
# =============================================================================

services:
  # ===========================================================================
  # PostgreSQL Database
  # ===========================================================================
  db:
    image: postgres:15-alpine
    container_name: vulnscan-db
    restart: unless-stopped
    
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: vulnscan
      # Performance tuning for development
      POSTGRES_INITDB_ARGS: "--encoding=UTF8"
    
    volumes:
      # Persistent data storage
      - postgres_data:/var/lib/postgresql/data
      # Optional: initialization scripts
      # - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    
    ports:
      # Expose for local database tools (optional)
      - "5432:5432"
    
    networks:
      - vulnscan-network
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d vulnscan"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ===========================================================================
  # FastAPI Backend Server
  # ===========================================================================
  api:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: vulnscan-api
    restart: unless-stopped
    
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    
    environment:
      # Database connection
      DATABASE_URL: postgresql+asyncpg://user:password@db:5432/vulnscan
      
      # Application settings
      ENVIRONMENT: development
      DEBUG: "true"
      LOG_LEVEL: INFO
      
      # API settings
      API_HOST: 0.0.0.0
      API_PORT: "8000"
      
      # Trivy settings
      TRIVY_BINARY_PATH: /usr/bin/trivy
      TRIVY_CACHE_DIR: /root/.cache/trivy
      TRIVY_TIMEOUT_SECONDS: "300"
      
      # Worker settings (for background tasks)
      WORKER_POLL_INTERVAL_SECONDS: "5"
      SCAN_MAX_RETRIES: "3"
      SCAN_CACHE_TTL_MINUTES: "60"
      
      # CORS (allow frontend)
      CORS_ORIGINS: '["http://localhost:5173","http://localhost:3000","http://frontend:80"]'
    
    volumes:
      # Mount source code for hot-reload during development
      - ./app:/app/app:ro
      # Shared Trivy cache between API and worker
      - trivy_cache:/root/.cache/trivy
    
    ports:
      - "8000:8000"
    
    networks:
      - vulnscan-network
    
    depends_on:
      db:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # ===========================================================================
  # Background Worker (Trivy Scanner)
  # ===========================================================================
  worker:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: vulnscan-worker
    restart: unless-stopped
    
    command: python -m app.worker
    
    environment:
      # Database connection (same as API)
      DATABASE_URL: postgresql+asyncpg://user:password@db:5432/vulnscan
      
      # Application settings
      ENVIRONMENT: development
      DEBUG: "false"
      LOG_LEVEL: INFO
      
      # Trivy settings
      TRIVY_BINARY_PATH: /usr/bin/trivy
      TRIVY_CACHE_DIR: /root/.cache/trivy
      TRIVY_TIMEOUT_SECONDS: "300"
      
      # Worker settings
      WORKER_POLL_INTERVAL_SECONDS: "5"
      SCAN_MAX_RETRIES: "3"
      
      # Risk scoring weights
      RISK_WEIGHT_CRITICAL: "100"
      RISK_WEIGHT_HIGH: "50"
      RISK_WEIGHT_MEDIUM: "10"
      RISK_WEIGHT_LOW: "1"
    
    volumes:
      # Mount source code for development
      - ./app:/app/app:ro
      # Shared Trivy cache
      - trivy_cache:/root/.cache/trivy
      # Docker socket for scanning local images (optional)
      # WARNING: This gives container access to host Docker daemon
      # - /var/run/docker.sock:/var/run/docker.sock:ro
    
    networks:
      - vulnscan-network
    
    depends_on:
      db:
        condition: service_healthy
      api:
        condition: service_started
    
    # No health check - worker doesn't expose HTTP
    # Process monitoring via Docker restart policy

  # ===========================================================================
  # React Frontend (Nginx)
  # ===========================================================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        VITE_API_URL: http://localhost:8000
    container_name: vulnscan-frontend
    restart: unless-stopped
    
    ports:
      - "5173:80"
    
    networks:
      - vulnscan-network
    
    depends_on:
      - api
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# =============================================================================
# Networks
# =============================================================================
networks:
  vulnscan-network:
    driver: bridge
    name: vulnscan-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  # PostgreSQL data persistence
  postgres_data:
    name: vulnscan-postgres-data
  
  # Trivy vulnerability database cache (shared between API and worker)
  trivy_cache:
    name: vulnscan-trivy-cache
